<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie Catcher Game</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #87CEEB, #98FB98);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .game-container {
            position: relative;
            width: 640px;
            height: 480px;
            border: 4px solid #8B4513;
            border-radius: 15px;
            overflow: hidden;
            background: #87CEEB;
        }

        #videoElement {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .ui {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 640px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .score {
            font-size: 24px;
            font-weight: bold;
            color: #8B4513;
        }

        .status {
            font-size: 18px;
            color: #2F4F4F;
        }

        .instructions {
            max-width: 640px;
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .cookie {
            position: absolute;
            width: 80px;
            height: 80px;
            z-index: 10;
            transition: all 0.1s ease;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            /* Remove any background styling - only show the PNG image */
        }

        .start-btn {
            background: #32CD32;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            background: #228B22;
            transform: translateY(-2px);
        }

        .start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .mouth-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            z-index: 20;
            transition: all 0.3s ease;
        }

        .mouth-open {
            background: rgba(50, 205, 50, 0.8);
            color: white;
        }

        .mouth-closed {
            background: rgba(255, 99, 71, 0.8);
            color: white;
        }
    </style>
</head>
<body>
    <div class="instructions">
        <h2>üç™ Cookie Catcher Game üç™</h2>
        <p>Open your mouth to catch falling cookies! Make sure your mouth is clearly open to score points.</p>
        <p>Allow camera access and click Start Game when ready.</p>
    </div>

    <div class="ui">
        <div class="score">Score: <span id="scoreValue">0</span></div>
        <button id="startBtn" class="start-btn">Start Game</button>
        <div class="status" id="status">Loading...</div>
    </div>

    <div class="game-container">
        <video id="videoElement" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="mouthIndicator" class="mouth-indicator mouth-closed">Mouth Closed</div>
    </div>

    <script>
        class CookieCatcherGame {
            constructor() {
                this.video = document.getElementById('videoElement');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.scoreElement = document.getElementById('scoreValue');
                this.statusElement = document.getElementById('status');
                this.startBtn = document.getElementById('startBtn');
                this.mouthIndicator = document.getElementById('mouthIndicator');
                
                this.score = 0;
                this.gameRunning = false;
                this.cookies = [];
                this.faceLandmarks = [];
                this.isMouthOpen = false;
                this.faceMesh = null;
                this.camera = null;
                
                // Cookie image path - replace this with your PNG file path
                this.cookieImagePath = 'static/cookies.png'; // UPDATE THIS PATH

                // Key mouth landmark indices for MediaPipe Face Mesh
                this.mouthLandmarkIndices = {
                    upperLip: [13, 14, 15, 16, 17, 18],
                    lowerLip: [404, 405, 320, 307, 375, 321],
                    innerMouth: [78, 81, 13, 311, 308, 415, 324, 318]
                };
                
                this.init();
            }

            async init() {
                this.statusElement.textContent = "Initializing camera...";
                await this.setupCamera();
                this.statusElement.textContent = "Loading face detection...";
                await this.setupFaceMesh();
                this.setupEventListeners();
                this.resizeCanvas();
                this.statusElement.textContent = "Ready! Click Start Game";
            }

            async setupCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }
                    });
                    this.video.srcObject = stream;
                    
                    return new Promise((resolve) => {
                        this.video.onloadedmetadata = () => {
                            resolve();
                        };
                    });
                } catch (err) {
                    this.statusElement.textContent = "Camera access denied!";
                    console.error("Camera error:", err);
                }
            }

            async setupFaceMesh() {
                try {
                    this.faceMesh = new FaceMesh({
                        locateFile: (file) => {
                            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                        }
                    });

                    this.faceMesh.setOptions({
                        maxNumFaces: 1,
                        refineLandmarks: true,
                        minDetectionConfidence: 0.7,
                        minTrackingConfidence: 0.7
                    });

                    this.faceMesh.onResults((results) => {
                        this.onResults(results);
                    });

                    this.camera = new Camera(this.video, {
                        onFrame: async () => {
                            await this.faceMesh.send({ image: this.video });
                        },
                        width: 640,
                        height: 480
                    });
                } catch (error) {
                    console.error("Face mesh setup error:", error);
                    this.statusElement.textContent = "Face detection failed to load";
                }
            }

            onResults(results) {
                // Clear canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    this.faceLandmarks = results.multiFaceLandmarks[0];
                    this.detectMouthState();
                    this.drawFaceIndicators();
                } else {
                    this.isMouthOpen = false;
                    this.updateMouthIndicator();
                }

                if (this.gameRunning) {
                    this.updateGame();
                }
            }

            detectMouthState() {
                if (!this.faceLandmarks || this.faceLandmarks.length < 468) {
                    this.isMouthOpen = false;
                    this.updateMouthIndicator();
                    return;
                }

                // Calculate mouth opening by measuring vertical distances
                const upperLip = this.faceLandmarks[13]; // Top of upper lip
                const lowerLip = this.faceLandmarks[14]; // Bottom of lower lip
                const leftCorner = this.faceLandmarks[61]; // Left mouth corner
                const rightCorner = this.faceLandmarks[291]; // Right mouth corner

                if (upperLip && lowerLip && leftCorner && rightCorner) {
                    // Calculate mouth height and width
                    const mouthHeight = Math.abs(upperLip.y - lowerLip.y);
                    const mouthWidth = Math.abs(leftCorner.x - rightCorner.x);
                    
                    // Mouth is considered open if height/width ratio exceeds threshold
                    const aspectRatio = mouthHeight / mouthWidth;
                    this.isMouthOpen = aspectRatio > 0.04; // Adjust this threshold as needed
                }

                this.updateMouthIndicator();
            }

            updateMouthIndicator() {
                if (this.isMouthOpen) {
                    this.mouthIndicator.textContent = "Mouth Open! ";
                    this.mouthIndicator.className = "mouth-indicator mouth-open";
                } else {
                    this.mouthIndicator.textContent = "Mouth Closed";
                    this.mouthIndicator.className = "mouth-indicator mouth-closed";
                }
            }

            drawFaceIndicators() {
                if (!this.faceLandmarks) return;

                // Draw mouth outline
                const color = this.isMouthOpen ? '#32CD32' : '#FF6347';
                this.ctx.strokeStyle = color;
                this.ctx.lineWidth = 2;
                this.ctx.fillStyle = color + '40';

                // Draw mouth region
                this.ctx.beginPath();
                const mouthIndices = [...this.mouthLandmarkIndices.upperLip, ...this.mouthLandmarkIndices.lowerLip];
                
                mouthIndices.forEach((index, i) => {
                    const landmark = this.faceLandmarks[index];
                    if (landmark) {
                        const x = (1 - landmark.x) * this.canvas.width; // Mirror for selfie view
                        const y = landmark.y * this.canvas.height;
                        
                        if (i === 0) {
                            this.ctx.moveTo(x, y);
                        } else {
                            this.ctx.lineTo(x, y);
                        }
                    }
                });
                
                this.ctx.closePath();
                this.ctx.fill();
                this.ctx.stroke();
            }

            setupEventListeners() {
                this.startBtn.addEventListener('click', () => {
                    if (!this.gameRunning) {
                        this.startGame();
                    } else {
                        this.stopGame();
                    }
                });

                window.addEventListener('resize', () => {
                    this.resizeCanvas();
                });
            }

            resizeCanvas() {
                this.canvas.width = this.video.offsetWidth || 640;
                this.canvas.height = this.video.offsetHeight || 480;
            }

            startGame() {
                if (!this.faceMesh) {
                    this.statusElement.textContent = "Please wait for face detection to load";
                    return;
                }

                this.gameRunning = true;
                this.score = 0;
                this.cookies = [];
                this.scoreElement.textContent = this.score;
                this.startBtn.textContent = "Stop Game";
                this.startBtn.style.background = "#DC143C";
                
                if (this.camera) {
                    this.camera.start();
                }
                
                this.spawnCookies();
                this.statusElement.textContent = "Game started! Catch cookies!";
            }

            stopGame() {
                this.gameRunning = false;
                this.clearCookies();
                this.startBtn.textContent = "Start Game";
                this.startBtn.style.background = "#32CD32";
                this.statusElement.textContent = `Game over! Final score: ${this.score}`;
            }

            clearCookies() {
                this.cookies.forEach(cookie => {
                    if (cookie.element && cookie.element.parentNode) {
                        cookie.element.parentNode.removeChild(cookie.element);
                    }
                });
                this.cookies = [];
            }

            spawnCookies() {
                if (!this.gameRunning) return;

                // Create new cookie
                const cookie = {
                    x: Math.random() * (this.canvas.width - 80) + 10,
                    y: -70,
                    speed: 2 + Math.random() * 2,
                    element: this.createCookieElement()
                };
                
                this.cookies.push(cookie);

                // Schedule next cookie spawn
                setTimeout(() => {
                    this.spawnCookies();
                }, 1000 + Math.random() * 1500);
            }

            createCookieElement() {
                const cookieEl = document.createElement('div');
                cookieEl.className = 'cookie';
                
                // Set the background image to your PNG file
                cookieEl.style.backgroundImage = `url('${this.cookieImagePath}')`;
                
                // Remove any default background styling
                cookieEl.style.backgroundColor = 'transparent';
                cookieEl.style.border = 'none';
                cookieEl.style.borderRadius = '0';
                
                document.querySelector('.game-container').appendChild(cookieEl);
                return cookieEl;
            }

            updateGame() {
                for (let i = this.cookies.length - 1; i >= 0; i--) {
                    const cookie = this.cookies[i];
                    cookie.y += cookie.speed;

                    // Update cookie visual position
                    if (cookie.element) {
                        cookie.element.style.left = cookie.x + 'px';
                        cookie.element.style.top = cookie.y + 'px';
                    }

                    // Check for mouth collision
                    if (this.isMouthOpen && this.checkCookieCollision(cookie)) {
                        this.score++;
                        this.scoreElement.textContent = this.score;
                        
                        // Remove cookie element
                        if (cookie.element && cookie.element.parentNode) {
                            cookie.element.parentNode.removeChild(cookie.element);
                        }
                        this.cookies.splice(i, 1);
                        continue;
                    }

                    // Remove cookies that have fallen off screen
                    if (cookie.y > this.canvas.height + 50) {
                        if (cookie.element && cookie.element.parentNode) {
                            cookie.element.parentNode.removeChild(cookie.element);
                        }
                        this.cookies.splice(i, 1);
                    }
                }
            }

            checkCookieCollision(cookie) {
                if (!this.faceLandmarks || !this.isMouthOpen) return false;

                // Get mouth center from key landmarks
                const mouthCenter = this.getMouthCenter();
                if (!mouthCenter) return false;

                // Calculate distance between cookie center and mouth center
                const cookieCenterX = cookie.x + 10; // Cookie width/2 (60px/2)
                const cookieCenterY = cookie.y + 10; // Cookie height/2 (60px/2)
                
                const distance = Math.sqrt(
                    Math.pow(cookieCenterX - mouthCenter.x, 2) + 
                    Math.pow(cookieCenterY - mouthCenter.y, 2)
                );

                return distance < 60; // Collision threshold
            }

            getMouthCenter() {
                if (!this.faceLandmarks) return null;

                const mouthIndices = [13, 14, 61, 291]; // Key mouth points
                let centerX = 0, centerY = 0, validPoints = 0;

                mouthIndices.forEach(index => {
                    const landmark = this.faceLandmarks[index];
                    if (landmark) {
                        centerX += (1 - landmark.x) * this.canvas.width; // Mirror x coordinate
                        centerY += landmark.y * this.canvas.height;
                        validPoints++;
                    }
                });

                if (validPoints === 0) return null;

                return {
                    x: centerX / validPoints,
                    y: centerY / validPoints
                };
            }
        }

        // Initialize the game when the page loads
        window.addEventListener('load', () => {
            new CookieCatcherGame();
        });
    </script>
</body>
</html>